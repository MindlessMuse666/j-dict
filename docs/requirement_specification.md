# Техническое задание: Личный русско-японский словарь

## Бизнес-требования (BR)

### Основные бизнес-требования

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **BR-001** | Управление личным словарем | Система должна позволять пользователям создавать, читать, обновлять и удалять слова для изучения японского языка | MUST HAVE | ✅ Реализовано |
| **BR-002** | Учет особенностей японского языка | Система должна корректно обрабатывать особенности японской письменности, включая разделение чтений на онъёми и кунъёми | MUST HAVE | ✅ Реализовано |
| **BR-003** | Эффективный поиск | Пользователи должны иметь возможность быстро находить слова по критериям: русскому переводу, японскому написанию, тегам | SHOULD HAVE | ✅ Реализовано |
| **BR-004** | Организация слов по темам | Система должна позволять группировать слова с помощью тегов для лучшей организации процесса изучения | SHOULD HAVE | ✅ Реализовано |
| **BR-005** | Отслеживание прогресса | Система должна сохранять историю создания и обновления слов для анализа прогресса изучения | COULD HAVE | ✅ Реализовано (Backend) |
| **BR-006** | Импорт данных | Пользователи должны иметь возможность импортировать слова из CSV-файлов | COULD HAVE | ✅ Реализовано |
| **BR-007** | Экспорт данных | Пользователи должны иметь возможность экспортировать слова в CSV-файл | WON'T HAVE | ❌ Отложено |

### Технические бизнес-требования

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **BR-008** | Простая интеграция с Kafka | Система должна обеспечивать простую и надежную интеграцию с Kafka для асинхронной обработки событий | MUST HAVE | ✅ Реализовано |
| **BR-009** | Публичное REST API | Система должна предоставлять хорошо документированное публичное REST API для использования сторонними сервисами и интеграциями | MUST HAVE | ✅ Реализовано |

## ⚙️ Функциональные требования (FR)

### Управление словами

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **FR-001** | Создание слова | Система должна позволять создавать новые слова с обязательными полями (`ru`, `jp`) и опциональными (`on`, `kun`, `ex_jp`, `ex_ru`, `tags`) | MUST HAVE | ✅ Реализовано |
| **FR-002** | Частичное обновление | При обновлении слова все поля должны быть опциональными. Если поле не передано - сохраняется текущее значение | MUST HAVE | ✅ Реализовано |
| **FR-003** | Редактирование слова | Система должна позволять обновлять существующие слова | MUST HAVE | ✅ Реализовано |
| **FR-004** | Удаление слова | Система должна позволять удалять слова с подтверждением действия | MUST HAVE | ✅ Реализовано |
| **FR-005** | Бесконечная лента слов | Система должна реализовывать пагинацию в стиле бесконечной ленты с автоподгрузкой при скролле | MUST HAVE | ✅ Реализовано |

### Поиск и фильтрация

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **FR-006** | Основной поиск | Система должна предоставлять поиск по полям `ru` и `jp` (подстрока в элементах массива) | SHOULD HAVE | ✅ Реализовано |
| **FR-007** | Расширенный поиск | Система должна предоставлять фильтрацию по тегам, онъёми и кунъёми (точное совпадение элемента массива) | SHOULD HAVE | ✅ Реализовано |
| **FR-008** | Пагинация с курсором | Система должна реализовывать курсорную пагинацию для бесконечной ленты | MUST HAVE | ✅ Реализовано |

### Аутентификация и безопасность

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **FR-009** | Регистрация | Возможность создания нового аккаунта с email и паролем | MUST HAVE | ✅ Реализовано |
| **FR-010** | Вход в систему | Аутентификация зарегистрированных пользователей | MUST HAVE | ✅ Реализовано |
| **FR-011** | Изоляция данных | Данные каждого пользователя должны быть полностью изолированы | MUST HAVE | ✅ Реализовано |
| **FR-012** | Выход из системы | Возможность завершения сессии | MUST HAVE | ✅ Реализовано |

### Документация

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **FR-013** | Swagger UI | Интерактивная документация API через веб-интерфейс | SHOULD HAVE | ✅ Реализовано |
| **FR-014** | OpenAPI спецификация | Полная спецификация API в форматах JSON/YAML | SHOULD HAVE | ✅ Реализовано |

## Нефункциональные требования (NFR)

### Архитектурные требования

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **NFR-001** | Конфигурация через переменные окружения | Все настройки должны храниться в переменных окружения и конфигурационных файлах | MUST HAVE | ✅ Реализовано |
| **NFR-002** | Документация кода на русском | Весь код должен содержать стандартизированные докстринги на русском языке | MUST HAVE | ✅ Реализовано |
| **NFR-003** | Слоистая архитектура | Разделение на handler -> service -> repository | MUST HAVE | ✅ Реализовано |
| **NFR-004** | Graceful shutdown | Корректное завершение работы при получении сигналов | SHOULD HAVE | ✅ Реализовано |
| **NFR-005** | Горизонтальное масштабирование | Архитектура должна поддерживать увеличение количества экземпляров сервисов | COULD HAVE | ⏳ В плане |

### Требования к производительности

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **NFR-006** | Время отклика API | Время ответа API не должно превышать 200мс для 95% запросов | SHOULD HAVE | ⏳ В плане |
| **NFR-007** | Обработка одновременных запросов | Система должна обрабатывать не менее 100 одновременных пользователей | SHOULD HAVE | ⏳ В плане |
| **NFR-008** | Эффективное использование памяти | Приложение должно эффективно использовать память при работе с большими наборами данных | SHOULD HAVE | ✅ Реализовано |

### Требования к надежности

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **NFR-009** | Обработка ошибок | Система должна корректно обрабатывать ошибки и предоставлять понятные сообщения пользователю | MUST HAVE | ✅ Реализовано |
| **NFR-010** | Отказоустойчивость Kafka | При недоступности Kafka система должна логировать события в консоль и продолжать работу | MUST HAVE | ✅ Реализовано |
| **NFR-011** | Восстановление после сбоев | Система должна восстанавливаться после перезапуска без потери данных | MUST HAVE | ✅ Реализовано |

### Требования к API

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **NFR-012** | Документация OpenAPI | API должно быть полностью описано в формате OpenAPI 3.0 | MUST HAVE | ✅ Реализовано |
| **NFR-013** | Стандартизированные ответы | Все ответы API должны следовать единому формату `{ "data": ... }` или `{ "error": ... }` | MUST HAVE | ✅ Реализовано |
| **NFR-014** | CORS-поддержка | API должно поддерживать CORS для кросс-доменных запросов | MUST HAVE | ✅ Реализовано |

### Требования к безопасности

| ID | Название | Описание | Приоритет | Статус |
| --- | --- | --- | --- | --- |
| **NFR-015** | Хэширование паролей | Пароли должны храниться в хэшированном виде с использованием bcrypt | MUST HAVE | ✅ Реализовано |
| **NFR-016** | JWT-аутентификация | API должно использовать JWT-токены для аутентификации запросов | MUST HAVE | ✅ Реализовано |
| **NFR-017** | CORS-политика | API должно иметь настроенную CORS-политику для безопасности | MUST HAVE | ✅ Реализовано |

## Схема базы данных

### Таблица `users` (✅ Реализовано)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Таблица `word`  (✅ Реализовано)

```sql
CREATE TABLE words (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    jp TEXT[] NOT NULL,
    ru TEXT[] NOT NULL,
    "on" TEXT[],
    kun TEXT[],
    ex_jp TEXT[],
    ex_ru TEXT[],
    tags TEXT[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Ограничения на длину массивов
    CONSTRAINT chk_ex_jp_length CHECK (array_length(ex_jp, 1) <= 3),
    CONSTRAINT chk_ex_ru_length CHECK (array_length(ex_ru, 1) <= 3),
    CONSTRAINT chk_tags_length CHECK (array_length(tags, 1) <= 5)
);
```

### Индексы (✅ Реализовано)

```sql
-- Основные индексы
CREATE INDEX idx_words_user_id ON words(user_id);
CREATE INDEX idx_words_jp ON words USING GIN(jp);
CREATE INDEX idx_words_ru ON words USING GIN(ru);
CREATE INDEX idx_words_tags ON words USING GIN(tags);
CREATE INDEX idx_words_created_at ON words(created_at DESC);

-- Частичные индексы
CREATE INDEX idx_words_onyomi ON words USING GIN("on") WHERE "on" IS NOT NULL;
CREATE INDEX idx_words_kunyomi ON words USING GIN(kun) WHERE kun IS NOT NULL;
```

## API-спецификация

### Формат ответов (✅ Реализовано)

- **Успех:** `{ "data": { ... } }`;
- **Ошибка:** `{ "error": "текст ошибки" }` с соответствующим HTTP-статусом.

### Endpoints (✅ Реализовано)

#### Аутентификация

- `POST /api/auth/register` - регистрация;
- `POST /api/auth/login` - вход;
- `GET /api/auth/me` - информация о пользователе;
- `POST /api/auth/logout` - выход.

#### Слова

- `GET /api/words` - список слов (пагинация);
- `GET /api/words/{id}` - слово по ID;
- `POST /api/words` - создание слова;
- `PATCH /api/words/{id}` - частичное обновление;
- `DELETE /api/words/{id}` - удаление слова;
- `GET /api/words/search` - поиск слов.

#### Системные

- `GET /api/health` - проверка работоспособности;
- `GET /swagger/*` - Swagger UI.

## Контейнеризация

### Сервисы (✅ Реализовано)

- **backend** - Go приложение (порт 8080)
- **postgres** - PostgreSQL 18 (порт 5432)
- **kafka** - Apache Kafka (порт 9092)
- **zookeeper** - Zookeeper для Kafka (порт 2181)
- **pgadmin** - Web интерфейс для БД (порт 5050, опционально)

### Health Checks (✅ Реализовано)

- **PostgreSQL:** `pg_isready`;
- **Kafka:** `kafka-topics --list`;
- **Backend:** `HTTP GET /api/health`.

## Стандарты разработки

### Документирование кода

#### Структуры данных

```go
// Word представляет слово в словаре пользователя
// Содержит основную информацию о японском слове и его переводе
type Word struct {
    ID  int       `json:"id" db:"id"`
    Jp  []string  `json:"jp" db:"jp"`   // Написания на японском
    Ru  []string  `json:"ru" db:"ru"`   // Переводы на русский язык
    // ... остальные поля
}
```

#### Функции и методы

```go
// CreateWord создает новое слово в словаре пользователя
// 
// Параметры:
//   - ctx: контекст выполнения для отмены и таймаутов
//   - word: структура с данными нового слова
//
// Возвращает:
//   - *Word: созданное слово с заполненным ID
//   - error: ошибка валидации или базы данных
func (s *WordService) CreateWord(ctx context.Context, word Word) (*Word, error) {
    // реализация
}
```

#### Модули и пакеты

```go
// Package repository предоставляет слой доступа к данным
// 
// Включает:
//   - WordRepository: работа со словами
//   - MigrationManager: управление миграциями БД
//   - QueryLoader: загрузка SQL запросов из файлов
package repository
```

#### Конфигурация приложения

```go
// Config содержит все настройки приложения
type Config struct {
    Database DatabaseConfig `yaml:"database" envPrefix:"DB_"`
    Server   ServerConfig   `yaml:"server" envPrefix:"SRV_"`
    Kafka    KafkaConfig    `yaml:"kafka" envPrefix:"KAFKA_"`
    Features FeatureFlags   `yaml:"features"`
}

// DatabaseConfig настройки подключения к PostgreSQL
type DatabaseConfig struct {
    Host     string `yaml:"host" env:"HOST" default:"localhost"`
    Port     int    `yaml:"port" env:"PORT" default:"5432"`
    User     string `yaml:"user" env:"USER" default:"app_user"`
    Password string `yaml:"password" env:"PASSWORD" required:"true"`
    Name     string `yaml:"name" env:"NAME" default:"jp_ru_dict"`
    SSLMode  string `yaml:"ssl_mode" env:"SSL_MODE" default:"disable"`
}
```
